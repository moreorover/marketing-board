# HTTP -> HTTPS
:80 {
    redir https://{host}{uri} permanent
}

{$DOMAIN:localhost} {
    # If you're using Cloudflare Origin Certs (recommended behind CF), keep this line.
    # Otherwise, remove it and let Caddy manage ACME/DNS-01.
    # tls /etc/certs/origin.pem /etc/certs/origin.key

    # Global logging (moved outside handle blocks)
    log {
        output file /var/log/caddy/access.log
        format json
    }

    # ---------- Cloudflare allowlist ----------
    @cloudflare {
        # Only accept requests that arrive from Cloudflare edge IPs
        remote_ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
    }

    # ---------- All requests must pass the Cloudflare matcher ----------
    handle @cloudflare {
        # Security headers
        header {
            Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
            X-Frame-Options "DENY"
            X-Content-Type-Options "nosniff"
            -Server
        }

        # Route by path
        route {
            @api path /api/*
            handle @api {
                reverse_proxy server:3000 {
                    # preserve real client IP from CF
                    header_up X-Real-IP {http.request.header.CF-Connecting-IP}
                    header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
                    # Removed X-Forwarded-Proto - Caddy handles this automatically
                }
            }

            @trpc path /trpc/*
            handle @trpc {
                reverse_proxy server:3000 {
                    header_up X-Real-IP {http.request.header.CF-Connecting-IP}
                    header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
                    # Removed X-Forwarded-Proto - Caddy handles this automatically
                }
            }

            # everything else -> web
            handle {
                reverse_proxy web:80 {
                    header_up X-Real-IP {http.request.header.CF-Connecting-IP}
                    header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
                    # Removed X-Forwarded-Proto - Caddy handles this automatically
                }
            }
        }

        # Compression
        encode gzip zstd
    }

    # Anything *not* from Cloudflare => 403
    handle {
        respond "Access Denied" 403
    }
}